<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>MediWave — AI Health Assistant</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg1: #0b2026;
      --bg2: #1a353f;
      --card: rgba(255, 255, 255, 0.12);
      --accent: #00c4b4;
      --danger: #ff6b6b;
      --muted: #a0b0b6;
      --glass-border: rgba(255, 255, 255, 0.18);
      --text: #e6f7f2;
      --shadow: rgba(0, 0, 0, 0.4);
    }

    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
      touch-action: manipulation;
    }

    .app {
      display: flex;
      gap: 16px;
      max-width: 1400px;
      margin: 16px auto;
      padding: 12px;
      min-height: calc(100vh - 32px);
      position: relative;
    }

    /* Sidebar */
    .sidebar {
      width: 300px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 20px;
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      box-shadow: 0 12px 40px var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: calc(100vh - 48px);
      overflow-y: auto;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: fixed;
      left: 16px;
      top: 16px;
      z-index: 1000;
      animation: waveGlow 4s infinite ease-in-out;
    }

    .sidebar:hover {
      box-shadow: 0 16px 48px var(--shadow);
    }

    .sidebar.collapsed {
      transform: translateX(-100%);
    }

    @keyframes waveGlow {
      0%, 100% { box-shadow: 0 12px 40px var(--shadow); }
      50% { box-shadow: 0 12px 48px rgba(0, 196, 180, 0.3); }
    }

    .sidebar-toggle {
      position: absolute;
      right: 12px;
      top: 12px;
      z-index: 1001;
      padding: 12px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(15px);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px var(--shadow);
      font-size: 18px;
      min-width: 44px;
      min-height: 44px;
    }

    .sidebar-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px var(--shadow);
    }

    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
      padding-bottom: 14px;
      border-bottom: 1px solid var(--glass-border);
    }

    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      object-fit: contain;
      background: linear-gradient(90deg, #00d4b8, #009688);
      box-shadow: 0 6px 16px var(--shadow);
      transition: transform 0.3s ease;
      padding: 4px;
    }

    .avatar:hover, .avatar:active {
      animation: waveLogo 1.5s ease-in-out;
    }

    @keyframes waveLogo {
      0%, 100% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.1) rotate(3deg); }
      75% { transform: scale(1.1) rotate(-3deg); }
    }

    .avatar[src=""] {
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
      color: #021;
      content: "MW";
    }

    .brand h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
      text-shadow: 0 2px 4px var(--shadow);
    }

    .small { 
      color: var(--muted); 
      font-size: 12px; 
      opacity: 0.8;
    }

    .sidebar .btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      color: var(--text);
      transition: all 0.2s ease;
      font-weight: 500;
      font-size: 14px;
      backdrop-filter: blur(10px);
      animation: wavePulse 3s infinite ease-in-out;
      min-height: 44px;
    }

    .sidebar .btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px var(--shadow);
    }

    .btn.new {
      background: linear-gradient(90deg, #0f1720, rgba(255, 255, 255, 0.1));
      font-weight: 600;
      color: var(--accent);
    }

    .btn.primary {
      background: linear-gradient(90deg, var(--accent), #009688);
      color: #021;
      border: none;
      font-weight: 600;
    }

    @keyframes wavePulse {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-2px); }
    }

    .history-section {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    .history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      color: var(--muted);
      font-size: 14px;
      transition: all 0.2s ease;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      min-height: 44px;
    }

    .history-item:hover {
      background: rgba(255, 255, 255, 0.2);
      color: var(--text);
      transform: translateX(4px);
    }

    .history-item.active {
      background: linear-gradient(90deg, rgba(0, 196, 180, 0.2), rgba(255, 255, 255, 0.1));
      color: var(--accent);
    }

    .delete-chat {
      padding: 6px;
      border-radius: 8px;
      background: rgba(255, 107, 107, 0.2);
      border: 1px solid var(--danger);
      color: var(--danger);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 32px;
      min-height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .delete-chat:hover {
      background: var(--danger);
      color: white;
      transform: scale(1.1);
    }

    .sidebar .footer {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
      padding-top: 14px;
      border-top: 1px solid var(--glass-border);
      opacity: 0.8;
    }

    .sidebar .footer a {
      color: var(--accent);
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: all 0.2s ease;
    }

    .sidebar .footer a:hover {
      border-bottom: 1px solid var(--accent);
      color: var(--text);
    }

    /* Main */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: calc(100vh - 48px);
      margin-left: 320px;
      transition: margin-left 0.3s ease;
    }

    .main.full-width {
      margin-left: 56px;
    }

    .header {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 16px;
      background: linear-gradient(180deg, var(--card), rgba(255, 255, 255, 0.05));
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      box-shadow: 0 6px 24px var(--shadow);
      backdrop-filter: blur(25px);
    }

    .header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: var(--accent);
      text-shadow: 0 2px 4px var(--shadow);
    }

    .card {
      background: linear-gradient(180deg, var(--card), rgba(255, 255, 255, 0.05));
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 36px var(--shadow);
      backdrop-filter: blur(25px);
    }

    /* Chat Area */
    .chat-area {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
      min-height: 0;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: rgba(0, 0, 0, 0.25);
      border-radius: 12px;
      border: 1px solid var(--glass-border);
      scrollbar-width: thin;
      scrollbar-color: var(--accent) transparent;
    }

    .messages::-webkit-scrollbar {
      width: 6px;
    }

    .messages::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 6px;
    }

    .msg {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 12px;
      line-height: 1.4;
      word-break: break-word;
      box-shadow: 0 6px 16px var(--shadow);
      backdrop-filter: blur(15px);
      font-size: 14px;
    }

    .msg.user {
      align-self: flex-end;
      background: linear-gradient(90deg, #0ea5ff, #60a5fa);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .msg.bot {
      align-self: flex-start;
      background: linear-gradient(90deg, var(--accent), #009688);
      color: #011;
      border-bottom-left-radius: 4px;
    }

    .msg.system {
      align-self: center;
      background: transparent;
      color: var(--muted);
      font-size: 13px;
      padding: 8px 12px;
      border-radius: 10px;
    }

    .input-row {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 12px;
      background: linear-gradient(180deg, var(--card), rgba(255, 255, 255, 0.05));
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      box-shadow: 0 6px 16px var(--shadow);
      backdrop-filter: blur(15px);
    }

    .input-row input[type="text"] {
      flex: 1;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--glass-border);
      background: rgba(0, 0, 0, 0.35);
      color: var(--text);
      outline: none;
      font-size: 14px;
      transition: all 0.2s ease;
      min-height: 44px;
    }

    .input-row input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 10px rgba(0, 196, 180, 0.4);
    }

    .send-btn, .voice-btn {
      padding: 12px 16px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: var(--accent);
      color: #021;
      font-weight: 600;
      box-shadow: 0 6px 16px var(--shadow);
      transition: all 0.2s ease;
      animation: wavePulse 3s infinite ease-in-out;
      min-width: 44px;
      min-height: 44px;
    }

    .send-btn:hover, .voice-btn:hover {
      background: #009688;
      transform: translateY(-2px);
    }

    .voice-btn.active {
      background: var(--danger);
    }

    .typing {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.12);
      border-radius: 10px;
    }

    .typing .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text);
      opacity: 0.3;
      animation: blink 1.2s infinite;
    }

    .typing .dot:nth-child(2) { animation-delay: 0.2s; }
    .typing .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink {
      0%, 80%, 100% { opacity: 0.3; }
      40% { opacity: 1; }
    }

    .muted { color: var(--muted); font-size: 13px; }

    .danger {
      background: linear-gradient(90deg, #ff6b6b, #ff3b3b);
      color: white;
      border: none;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      min-height: 44px;
    }

    .lang-select {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
    }

    .pill {
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
      min-height: 36px;
    }

    .pill:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .pill.active {
      border: 1px solid var(--accent);
      background: var(--accent);
      color: #021;
    }

    /* Mobile Styles */
    @media (max-width: 768px) {
      .app {
        flex-direction: column;
        padding: 8px;
        margin: 8px;
      }

      .sidebar {
        width: 100%;
        max-width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        border-radius: 0;
        padding: 16px;
        z-index: 1000;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .sidebar.collapsed {
        transform: translateX(-100%);
      }

      .sidebar:not(.collapsed) {
        transform: translateX(0);
      }

      .main {
        margin-left: 0;
        height: calc(100vh - 32px);
      }

      .main.full-width {
        margin-left: 0;
      }

      .sidebar-toggle {
        right: 8px;
        top: 8px;
      }

      .header {
        padding: 10px 12px;
      }

      .header h2 {
        font-size: 18px;
      }

      .chat-area {
        min-height: 0;
        flex: 1;
      }

      .messages {
        padding: 10px;
        gap: 8px;
      }

      .msg {
        max-width: 90%;
        font-size: 13px;
        padding: 8px 12px;
      }

      .input-row {
        padding: 10px;
        gap: 6px;
      }

      .input-row input[type="text"] {
        font-size: 13px;
        padding: 10px 12px;
      }

      .send-btn, .voice-btn {
        padding: 10px;
        font-size: 13px;
      }

      .brand h3 {
        font-size: 16px;
      }

      .small {
        font-size: 11px;
      }

      .sidebar .btn {
        font-size: 13px;
        padding: 10px 12px;
      }

      .history-item {
        font-size: 13px;
        padding: 8px 10px;
      }

      .delete-chat {
        display: block;
      }

      .sidebar .footer {
        font-size: 11px;
      }

      .pill {
        font-size: 12px;
        padding: 6px 10px;
      }

      @keyframes wavePulse {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-1px); }
      }
    }

    @media (max-width: 480px) {
      .avatar {
        width: 40px;
        height: 40px;
        border-radius: 12px;
      }

      .header h2 {
        font-size: 16px;
      }

      .input-row input[type="text"] {
        font-size: 12px;
      }

      .send-btn, .voice-btn {
        padding: 8px;
        font-size: 12px;
      }

      .msg {
        font-size: 12px;
      }

      .delete-chat {
        font-size: 11px;
        min-width: 28px;
        min-height: 28px;
      }
    }

    canvas#particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -2;
    }

    .vignette {
      pointer-events: none;
      position: fixed;
      inset: 0;
      background: radial-gradient(ellipse at center, rgba(0, 0, 0, 0) 50%, rgba(0, 0, 0, 0.4) 100%);
      z-index: -1;
    }
  </style>
</head>
<body>
  <canvas id="particles"></canvas>
  <div class="vignette"></div>

  <div class="app container">
    <aside class="sidebar card collapsed" role="navigation" aria-label="Sidebar">
      <div class="brand">
        <img src="https://i.ibb.co/mV9z3F7m/a-logo-design-featuring-the-text-mediwav-7-J1-E77-Vg-QOSMIwh-Ov-Ln-Ex-A-0-Cctf-V1n-Ro-Gs-S8o-1-Ov-Bg.jpg" alt="MediWave Logo" class="avatar">
        <div>
          <h3>MediWave</h3>
          <div class="small">Educational tool — not a doctor</div>
        </div>
      </div>

      <button class="btn new" id="newChatBtn">+ New Chat</button>

      <div class="history-section" id="chatHistory"></div>

      <div>
        <button class="btn" id="dailyTipBtn">💡 Daily Health Tip</button>
        <button class="btn danger" id="emergencyBtnLeft">🚨 Emergency Help</button>
        <button class="btn danger" id="clearAllBtn">🗑️ Clear All Chats</button>
      </div>

      <div class="lang-select">
        <div class="muted">Language</div>
        <div style="display: flex; gap: 8px; margin-top: 8px;">
          <div class="pill active" id="langEn">English</div>
          <div class="pill" id="langHi">हिन्दी</div>
        </div>
      </div>

      <div class="footer muted">
        Made by <a href="https://atharvagrawal-18.web.app" target="_blank"><strong>Atharv</strong></a> • Demo
      </div>
    </aside>

    <main class="main full-width">
      <div class="header">
        <div>
          <h2>💬 MediWave</h2>
          <div class="muted">Ask about symptoms, diet, fitness, or wellness</div>
        </div>
        <button class="sidebar-toggle" id="sidebarToggle">☰</button>
      </div>

      <section class="chat-area card">
        <div id="messages" class="messages" aria-live="polite" role="log">
          <div class="msg system">Tip: This is an educational assistant. For emergencies, call local services.</div>
        </div>

        <div class="input-row">
          <input id="inputBox" type="text" placeholder="Ask about health, fitness, or diet..." aria-label="Message input" />
          <button class="voice-btn" id="voiceBtn" title="Voice Input">🎙️</button>
          <button class="send-btn" id="sendBtn">Send</button>
        </div>
      </section>
    </main>
  </div>

  <script>
    const API_KEY = "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";
    const USE_OPENAI = !!API_KEY;
    const OPENAI_ENDPOINT = "https://api.openai.com/v1/chat/completions";
    const MODEL = "gpt-4o-mini";

    let language = "english";
    let currentChatId = null;
    let chatHistory = JSON.parse(localStorage.getItem("chatHistory")) || [];
    let isSidebarCollapsed = true;

    const messagesEl = document.getElementById("messages");
    const inputBox = document.getElementById("inputBox");
    const sendBtn = document.getElementById("sendBtn");
    const voiceBtn = document.getElementById("voiceBtn");
    const newChatBtn = document.getElementById("newChatBtn");
    const dailyTipBtn = document.getElementById("dailyTipBtn");
    const emergencyBtnLeft = document.getElementById("emergencyBtnLeft");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const langEn = document.getElementById("langEn");
    const langHi = document.getElementById("langHi");
    const chatHistoryEl = document.getElementById("chatHistory");
    const sidebarToggle = document.getElementById("sidebarToggle");
    const sidebar = document.querySelector(".sidebar");
    const main = document.querySelector(".main");

    // Sidebar toggle
    sidebarToggle.addEventListener("click", () => {
      isSidebarCollapsed = !isSidebarCollapsed;
      sidebar.classList.toggle("collapsed");
      main.classList.toggle("full-width");
      sidebarToggle.textContent = isSidebarCollapsed ? "☰" : "←";
    });

    // Swipe Gestures
    let touchStartX = 0;
    let touchEndX = 0;
    document.addEventListener("touchstart", e => {
      if (window.innerWidth > 768) return;
      touchStartX = e.changedTouches[0].screenX;
    });
    document.addEventListener("touchend", e => {
      if (window.innerWidth > 768) return;
      touchEndX = e.changedTouches[0].screenX;
      if (touchEndX - touchStartX > 100 && isSidebarCollapsed) {
        isSidebarCollapsed = false;
        sidebar.classList.remove("collapsed");
        main.classList.remove("full-width");
        sidebarToggle.textContent = "←";
      } else if (touchStartX - touchEndX > 100 && !isSidebarCollapsed) {
        isSidebarCollapsed = true;
        sidebar.classList.add("collapsed");
        main.classList.add("full-width");
        sidebarToggle.textContent = "☰";
      }
    });

    function appendMessage(role, htmlContent, opts = {}) {
      const d = document.createElement("div");
      d.className = `msg ${role}`;
      if (opts.raw) d.innerHTML = htmlContent;
      else d.textContent = htmlContent;
      messagesEl.appendChild(d);
      d.scrollIntoView({ behavior: "smooth", block: "end" });
      if (currentChatId && role !== "system") {
        const chat = chatHistory.find(c => c.id === currentChatId);
        if (chat) {
          chat.messages.push({ role, content: htmlContent });
          saveChatHistory();
        }
      }
      return d;
    }

    function addTypingIndicator() {
      const el = document.createElement("div");
      el.className = "msg bot";
      el.innerHTML = `<div class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>`;
      messagesEl.appendChild(el);
      el.scrollIntoView({ behavior: "smooth", block: "end" });
      return el;
    }

    function fallbackAnswer(userText) {
      const s = userText.toLowerCase();
      if (/(fever|temperature|cough|cold|sore throat)/.test(s)) {
        return language === "hindi"
          ? "ये लक्षण बुखार/सर्दी के हो सकते हैं। आराम करें, पानी पिएँ और जरूरत पड़े तो डॉक्टर से संपर्क करें।"
          : "These sound like flu/cold symptoms. Rest, stay hydrated, and consult a doctor if symptoms worsen.";
      }
      if (/(headache|migraine|dizzy)/.test(s)) {
        return language === "hindi"
          ? "सरदर्द अक्सर तनाव या प्यास की वजह से होता है। पानी पिएँ और आराम करें।"
          : "Headaches can be from dehydration or stress. Drink water and rest.";
      }
      if (/(stomach|vomit|diarrhea|nausea)/.test(s)) {
        return language === "hindi"
          ? "पेट संबंधी समस्याओं में हल्का भोजन लें और पानी पिएँ। लक्षण गंभीर हों तो डॉक्टर से मिलें।"
          : "For stomach issues, stick to light food and hydrate. See a doctor if severe.";
      }
      if (/(exercise|workout|fitness)/.test(s)) {
        return language === "hindi"
          ? "व्यायाम कम से कम 3-4 बार/सप्ताह करें और धीरे-धीरे समय बढ़ाएँ।"
          : "Aim for regular exercise 3–4 times per week; increase duration gradually.";
      }
      if (/(diet|food|what to eat)/.test(s)) {
        return language === "hindi"
          ? "संतुलित आहार लें: फल, सब्जियाँ, प्रोटीन और पानी को प्राथमिकता दें।"
          : "Eat a balanced diet: fruits, vegetables, protein, and stay hydrated.";
      }
      return language === "hindi"
        ? "मुझे केवल स्वास्थ्य, आहार, फिटनेस और वेलनेस से जुड़े सवाल पूछें।"
        : "Please ask only health, diet, fitness, or wellness related questions.";
    }

    async function callOpenAI(userText) {
      const systemMsg = language === "hindi"
        ? "आप एक AI स्वास्थ्य सहायक हैं। केवल स्वास्थ्य, फिटनेस, आहार, और वेलनेस से जुड़े प्रश्नों का उत्तर दें।"
        : "You are an AI Health Assistant. Only answer health, fitness, diet, and wellness related questions. Politely refuse unrelated queries.";
      const payload = {
        model: MODEL,
        messages: [
          { role: "system", content: systemMsg },
          { role: "user", content: userText }
        ],
        temperature: 0.2,
        max_tokens: 512
      };
      const res = await fetch(OPENAI_ENDPOINT, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${API_KEY}`
        },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error("OpenAI error: " + (txt || res.status));
      }
      const data = await res.json();
      return data.choices?.[0]?.message?.content || "Sorry, no reply.";
    }

    function typeWriterInto(el, text, speed = 18) {
      return new Promise(resolve => {
        el.textContent = "";
        let i = 0;
        const interval = setInterval(() => {
          el.textContent += text.charAt(i) || "";
          i++;
          el.scrollIntoView({ behavior: "smooth", block: "end" });
          if (i > text.length) {
            clearInterval(interval);
            resolve();
          }
        }, speed);
      });
    }

    async function handleSend(text) {
      if (!text) return;
      appendMessage("user", text);
      inputBox.value = "";
      inputBox.focus();

      const typingEl = addTypingIndicator();
      try {
        let reply = USE_OPENAI ? await callOpenAI(text) : await new Promise(r => setTimeout(() => r(fallbackAnswer(text)), 700));
        typingEl.remove();
        const botEl = appendMessage("bot", "");
        await typeWriterInto(botEl, reply, 16);
      } catch (err) {
        typingEl.remove();
        appendMessage("bot", "⚠️ Error: " + (err.message || "Network / API error"));
        console.error(err);
      }
    }

    const recognition = window.SpeechRecognition ? new window.SpeechRecognition() : null;
    if (recognition) {
      recognition.lang = "en-US";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      voiceBtn.addEventListener("click", () => {
        if (voiceBtn.classList.contains("active")) {
          recognition.stop();
          voiceBtn.classList.remove("active");
        } else {
          recognition.lang = language === "hindi" ? "hi-IN" : "en-US";
          recognition.start();
          voiceBtn.classList.add("active");
        }
      });

      recognition.onresult = event => {
        const transcript = event.results[0][0].transcript;
        inputBox.value = transcript;
        handleSend(transcript);
      };

      recognition.onend = () => {
        voiceBtn.classList.remove("active");
      };

      recognition.onerror = event => {
        voiceBtn.classList.remove("active");
        appendMessage("system", "Voice input error: " + event.error);
      };
    } else {
      voiceBtn.style.display = "none";
    }

    function saveChatHistory() {
      localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
      renderChatHistory();
    }

    function newChat() {
      currentChatId = Date.now().toString();
      chatHistory.push({
        id: currentChatId,
        title: "Chat " + (chatHistory.length + 1),
        messages: [],
        createdAt: new Date().toISOString()
      });
      messagesEl.innerHTML = "";
      appendMessage("system", language === "hindi" ? "नया चैट शुरू किया गया।" : "New chat started.");
      saveChatHistory();
    }

    function deleteChat(chatId) {
      if (!confirm(language === "hindi" ? "क्या आप इस चैट को हटाना चाहते हैं?" : "Are you sure you want to delete this chat?")) {
        return;
      }
      chatHistory = chatHistory.filter(chat => chat.id !== chatId);
      if (chatId === currentChatId) {
        currentChatId = null;
        messagesEl.innerHTML = "";
        if (chatHistory.length > 0) {
          currentChatId = chatHistory[0].id;
          chatHistory[0].messages.forEach(msg => appendMessage(msg.role, msg.content));
        } else {
          newChat();
        }
      }
      saveChatHistory();
      appendMessage("system", language === "hindi" ? "चैट हटा दी गई।" : "Chat deleted.");
    }

    function clearAllChats() {
      if (!confirm(language === "hindi" ? "क्या आप सभी चैट हटाना चाहते हैं?" : "Are you sure you want to clear all chats?")) {
        return;
      }
      chatHistory = [];
      currentChatId = null;
      messagesEl.innerHTML = "";
      newChat();
      saveChatHistory();
      appendMessage("system", language === "hindi" ? "सभी चैट हटा दी गईं।" : "All chats cleared.");
    }

    function renderChatHistory() {
      chatHistoryEl.innerHTML = "";
      chatHistory.forEach(chat => {
        const el = document.createElement("div");
        el.className = `history-item ${chat.id === currentChatId ? "active" : ""}`;
        el.innerHTML = `
          <span>💬 ${chat.title}</span>
          <div style="display: flex; align-items: center; gap: 8px;">
            <span class="muted" style="font-size: 13px;">${new Date(chat.createdAt).toLocaleDateString()}</span>
            <button class="delete-chat" title="${language === "hindi" ? "चैट हटाएँ" : "Delete Chat"}">🗑️</button>
          </div>
        `;
        el.querySelector(".delete-chat").onclick = (e) => {
          e.stopPropagation();
          deleteChat(chat.id);
        };
        el.onclick = () => {
          currentChatId = chat.id;
          messagesEl.innerHTML = "";
          chat.messages.forEach(msg => appendMessage(msg.role, msg.content));
          renderChatHistory();
        };
        chatHistoryEl.appendChild(el);
      });
    }

    function dailyTip() {
      const tips = [
        "Drink at least 8 glasses of water daily.",
        "Sleep 7–8 hours for better recovery.",
        "Include fruits & vegetables every day.",
        "Take short walks after meals for digestion.",
        "Limit screen time before bed for improved sleep."
      ];
      const tip = tips[Math.floor(Math.random() * tips.length)];
      appendMessage("bot", "💡 " + tip);
    }

    function emergencyHelp() {
      const msg = language === "hindi"
        ? "🚨 आपातकालीन स्थिति में तुरंत 108 (एम्बुलेंस) या अपने स्थानीय आपातकालीन नंबर पर कॉल करें!"
        : "🚨 In an emergency, call 108 (ambulance India) or your local emergency number immediately!";
      appendMessage("bot", msg);
    }

    sendBtn.addEventListener("click", () => handleSend(inputBox.value.trim()));
    inputBox.addEventListener("keydown", e => { if (e.key === "Enter") handleSend(inputBox.value.trim()); });
    newChatBtn.addEventListener("click", newChat);
    dailyTipBtn.addEventListener("click", dailyTip);
    emergencyBtnLeft.addEventListener("click", emergencyHelp);
    clearAllBtn.addEventListener("click", clearAllChats);
    langEn.addEventListener("click", () => {
      language = "english";
      langEn.classList.add("active");
      langHi.classList.remove("active");
      appendMessage("system", "Language set to English");
    });
    langHi.addEventListener("click", () => {
      language = "hindi";
      langHi.classList.add("active");
      langEn.classList.remove("active");
      appendMessage("system", "भाषा हिन्दी पर सेट की गई");
    });

    if (chatHistory.length === 0) {
      newChat();
    } else {
      currentChatId = chatHistory[0].id;
      chatHistory[0].messages.forEach(msg => appendMessage(msg.role, msg.content));
      renderChatHistory();
    }
    appendMessage("bot", language === "hindi"
      ? "नमस्ते! मैं आपका MediWave हेल्थ असिस्टेंट हूँ — मुझसे स्वास्थ्य, फिटनेस और आहार पूछें।"
      : "Hello! I'm your MediWave Health Assistant — ask me about health, fitness, or diet.");

    // 3D Particles with Wave Motion and Star Effects
    (function particles() {
      const canvas = document.getElementById("particles");
      const ctx = canvas.getContext("2d");
      let DPR = window.devicePixelRatio || 1;

      function resize() {
        canvas.width = innerWidth * DPR;
        canvas.height = innerHeight * DPR;
        canvas.style.width = innerWidth + "px";
        canvas.style.height = innerHeight + "px";
        ctx.scale(DPR, DPR);
      }
      window.addEventListener("resize", resize);
      resize();

      const isMobile = window.innerWidth <= 768;
      const numParticles = isMobile ? 40 : Math.min(100, Math.floor((innerWidth * innerHeight) / 9000));
      const fov = 500;

      class Particle {
        constructor() {
          this.x = Math.random() * innerWidth;
          this.y = Math.random() * innerHeight;
          this.z = Math.random() * fov;
          this.size = 2 + Math.random() * 3;
          this.vx = (Math.random() - 0.5) * 0.8;
          this.vy = (Math.random() - 0.5) * 0.8;
          this.vz = (Math.random() - 0.5) * 0.8;
          this.hue = 160 + Math.random() * 60;
          this.waveOffset = Math.random() * Math.PI * 2;
          this.twinkleOffset = Math.random() * Math.PI * 2;
        }

        update() {
          this.x += this.vx;
          this.y += this.vy + Math.sin(Date.now() * 0.002 + this.waveOffset) * 0.5;
          this.z += this.vz;

          if (this.z < 10) {
            this.z = 10;
            this.vz *= -0.8;
          } else if (this.z > fov) {
            this.z = fov;
            this.vz *= -0.8;
          }
          if (this.x < -50) this.x = innerWidth + 50;
          if (this.x > innerWidth + 50) this.x = -50;
          if (this.y < -50) this.y = innerHeight + 50;
          if (this.y > innerHeight + 50) this.y = -50;
        }

        draw() {
          const scale = fov / (fov + this.z);
          const x2d = this.x * scale + innerWidth / 2;
          const y2d = this.y * scale + innerHeight / 2;
          const scaledSize = this.size * scale * (1 + 0.2 * Math.sin(Date.now() * 0.002 + this.waveOffset));
          const twinkle = 0.3 + 0.2 * Math.sin(Date.now() * 0.003 + this.twinkleOffset);
          ctx.beginPath();
          ctx.fillStyle = `hsla(${this.hue}, 80%, 60%, ${twinkle * scale})`;
          ctx.arc(x2d, y2d, scaledSize, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      class ShootingStar {
        constructor() {
          this.reset();
        }

        reset() {
          this.x = Math.random() * innerWidth;
          this.y = Math.random() * innerHeight / 4;
          this.z = fov * 0.5;
          this.vx = (Math.random() - 0.5) * 8;
          this.vy = Math.random() * 4 + 2;
          this.length = 20 + Math.random() * 20;
          this.opacity = 0.8;
          this.life = 60 + Math.random() * 60;
          this.age = 0;
        }

        update() {
          this.x += this.vx;
          this.y += this.vy;
          this.age++;
          this.opacity = 0.8 * (1 - this.age / this.life);
          if (this.age > this.life || this.x < 0 || this.x > innerWidth || this.y > innerHeight) {
            this.reset();
          }
        }

        draw() {
          const scale = fov / (fov + this.z);
          const x2d = this.x * scale + innerWidth / 2;
          const y2d = this.y * scale + innerHeight / 2;
          const tailX = x2d - this.vx * this.length * scale;
          const tailY = y2d - this.vy * this.length * scale;
          const gradient = ctx.createLinearGradient(x2d, y2d, tailX, tailY);
          gradient.addColorStop(0, `hsla(180, 80%, 80%, ${this.opacity})`);
          gradient.addColorStop(1, `hsla(180, 80%, 80%, 0)`);
          ctx.beginPath();
          ctx.strokeStyle = gradient;
          ctx.lineWidth = 1;
          ctx.moveTo(x2d, y2d);
          ctx.lineTo(tailX, tailY);
          ctx.stroke();
        }
      }

      const particlesArray = [];
      for (let i = 0; i < numParticles; i++) {
        particlesArray.push(new Particle());
      }

      const shootingStars = [];
      const maxShootingStars = isMobile ? 2 : 5;
      for (let i = 0; i < maxShootingStars; i++) {
        shootingStars.push(new ShootingStar());
      }

      function loop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const g = ctx.createLinearGradient(0, 0, innerWidth, innerHeight);
        g.addColorStop(0, 'rgba(10, 30, 40, 0.2)');
        g.addColorStop(1, 'rgba(30, 60, 70, 0.2)');
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, innerWidth, innerHeight);

        particlesArray.forEach(particle => {
          particle.update();
          particle.draw();
        });

        shootingStars.forEach(star => {
          star.update();
          star.draw();
        });

        for (let i = 0; i < particlesArray.length; i++) {
          for (let j = i + 1; j < particlesArray.length; j++) {
            const p1 = particlesArray[i];
            const p2 = particlesArray[j];
            const scale1 = fov / (fov + p1.z);
            const scale2 = fov / (fov + p2.z);
            const x1 = p1.x * scale1 + innerWidth / 2;
            const y1 = p1.y * scale1 + innerHeight / 2;
            const x2 = p2.x * scale2 + innerWidth / 2;
            const y2 = p2.y * scale2 + innerHeight / 2;
            const dist = Math.hypot(x1 - x2, y1 - y2);

            if (dist < 100) {
              const waveOpacity = 0.1 * (1 - dist / 100) * (1 + 0.3 * Math.sin(Date.now() * 0.002));
              ctx.beginPath();
              ctx.strokeStyle = `hsla(${p1.hue}, 70%, 50%, ${waveOpacity})`;
              ctx.lineWidth = 0.5;
              ctx.moveTo(x1, y1);
              ctx.lineTo(x2, y2);
              ctx.stroke();
            }
          }
        }

        requestAnimationFrame(loop);
      }
      loop();
    })();

    window.addEventListener("load", () => { inputBox.focus(); });
  </script>
</body>
</html>
